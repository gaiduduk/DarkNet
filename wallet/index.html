<!DOCTYPE html>
<html lang="en">
<head>
    <!--https://material.angularjs.org/latest/-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet</title>
    <link rel="icon" type="image/x-icon" href="img/fav.svg">
    <script src="/angular/angular.min.js"></script>
    <link href="/angular/angular-material.min.css" rel="stylesheet">
    <link href="/angular/binance_style.css" rel="stylesheet">
    <link href="/angular/colors.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
    <script src="/angular/angular-material.min.js"></script>
    <script src="/wallet/utils.js"></script>
    <script src="formats.js"></script>


    <script src="/swap/options/controller.js"></script>
    <script src="/wallet/launch/controller.js"></script>
    <script src="/wallet/login/controller.js"></script>
    <script src="/wallet/send/controller.js"></script>

    <script>
        angular.module("App", ['ngMaterial', 'ngAnimate'])
            .controller("Controller", function ($scope, $http, $mdBottomSheet, $mdToast) {
                addFormats($scope)
                window.$mdToast = $mdToast

                $scope.menuIndex = 0

                $scope.login = function () {
                    openLoginDialog($mdBottomSheet, $mdToast, updateCoins)
                }

                $scope.options = function (wallet_path) {
                    openOptionsDialog($mdBottomSheet, wallet_path, updateCoins)
                }

                $scope.logout = function () {
                    wallet.logout()
                    $mdToast.show($mdToast.simple().textContent("Success logout"))
                }

                $scope.launch = function () {
                    openLaunchDialog($mdBottomSheet, $mdToast, $scope.search_text, updateCoins)
                }

                $scope.show_launcher = false
                $scope.$watch('search_text', function (newValue) {
                    if (newValue == null) return;
                    if (newValue == "") {
                        $scope.show_launcher = false
                        updateCoins()
                        loadRecs()
                    } else {
                        $scope.show_launcher = true
                        post('/wallet/api/search', {
                            path: "wallet/info",
                            search_text: newValue
                        }, function (response) {
                            $scope.recs = response.result
                            for (let coin of response.result)
                                coin.isFavorite = wallet.domainExist(coin.domain)
                            $scope.$apply()
                        }, function () {
                            $scope.recs = []
                            $scope.$apply()
                        })
                    }
                })

                $scope.coins = []
                $scope.recs = []

                function updateCoins() {
                    var domains = wallet.domains()
                    if (domains.length == 0) {
                        $scope.coins = []
                    } else {
                        post("/wallet/api/list", {
                            domains: domains.join(",")
                        }, function (response) {
                            $scope.coins = response.result
                            $scope.$apply()
                        })
                    }
                }

                function loadRecs() {
                    var recDomains = [
                        "data",
                        "usdt",
                    ]
                    for (let domain of wallet.domains())
                        if (recDomains.indexOf(domain) != -1)
                            recDomains.splice(recDomains.indexOf(domain), 1)
                    if (recDomains.length == 0) {
                        $scope.recs = []
                    } else {
                        post("/wallet/api/list", {
                            domains: recDomains.join(",")
                        }, function (response) {
                            $scope.recs = response.result
                            $scope.$apply()
                        })
                    }
                }

                updateCoins()
                loadRecs()
                $scope.toggleFavorite = function (domain) {
                    if (wallet.domainExist(domain)){
                        wallet.domainDel(domain)
                    } else {
                        wallet.domainAdd(domain)
                    }
                    updateCoins()
                    loadRecs()
                }
            })
    </script>
</head>
<body class="col" ng-app="App" ng-controller="Controller">
<div class="row row-content align-start-center blue-back">
    <img class="coin img-red" src="img/fav.svg"/>
    <div class="row flex input-wrapper">
        <input type="text" class="flex input white-back-ripple" ng-model="search_text" placeholder="Search"
               style=" border-radius: 20px; padding-top: 1px">
    </div>
    <md-menu md-position-mode="target-right target">
        <img class="coin img-white" src="img/menu.svg" ng-click="$mdMenu.open($event)"/>
        <md-menu-content width="4">
            <md-menu-item class="row row-content align-start-center white-back-ripple" ng-click="launch()">
                <img class="coin" src="img/security.svg"/>
                <span>Launch</span>
            </md-menu-item>
            <md-menu-item class="row row-content align-start-center white-back-ripple" ng-click="login()">
                <img class="coin" src="img/security.svg"/>
                <span>Login</span>
            </md-menu-item>
            <md-menu-item class="row row-content align-start-center white-back-ripple" ng-click="logout()">
                <img class="coin" src="img/usdt.svg"/>
                <span>Logout</span>
            </md-menu-item>
        </md-menu-content>
    </md-menu>
</div>
<div class="col col-content row-content">
    <span>Your coins</span>
</div>
<div class="col" ng-repeat="(key, item) in coins">
    <div class="row align-start-center row-content white-back-ripple"
         ng-click="options(key)">
        <img class="coin" src="img/coin.svg">
        <span class="flex size14">{{tickerFormat(item.domain)}}</span>
        <span>{{item.balance}}</span>
    </div>
    <div class="divider"></div>
</div>
<div class="col col-content row-content">
    <span>Other coins</span>
</div>
<div class="col" ng-repeat="item in recs">
    <div class="row align-start-center row-content white-back-ripple">
        <img class="coin" src="img/coin.svg">
        <span class="flex size14">{{tickerFormat(item.domain)}}</span>
        <md-switch ng-change="toggleFavorite(item.domain)"
                   ng-model="item.isFavorite"/>
    </div>
    <div class="divider"></div>
</div>
<div class="row align-center-center white-back-ripple"
     ng-click="launch()"
     ng-show="show_launcher">
    <md-button class="md-fab"></md-button>
    Launch new coin
</div>
</body>
</html>