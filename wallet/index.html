<!DOCTYPE html>
<html lang="en">
<head>
    <!--https://material.angularjs.org/latest/-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet</title>
    <link rel="icon" type="image/x-icon" href="logo.svg">
    <script src="/angular/angular.min.js"></script>
    <link href="/angular/angular-material.min.css" rel="stylesheet">
    <link href="/angular/binance_style.css" rel="stylesheet">
    <link href="/angular/colors.css" rel="stylesheet">
    <script src="/angular/angular-material.min.js"></script>
    <script src="/wallet/utils.js"></script>
    <script src="formats.js"></script>
    <link href="style.css" rel="stylesheet">


    <script src="/wallet/options/controller.js"></script>
    <script src="/wallet/launch/controller.js"></script>
    <script src="/wallet/login/controller.js"></script>
    <script src="/wallet/send/controller.js"></script>
    <script src="/wallet/ico/sell/controller.js"></script>
    <script src="/wallet/ico/buy/controller.js"></script>
    <script src="/wallet/success/controller.js"></script>
    <script src="/wallet/invite/create/controller.js"></script>
    <script src="/wallet/invite/copy/controller.js"></script>
    <script src="/wallet/invite/receive/controller.js"></script>

    <script>
        angular.module("App", ['ngMaterial', 'ngAnimate'])
            .controller("Controller", function ($scope, $http, $mdBottomSheet, $mdDialog, $mdToast) {
                addFormats($scope)
                window.$mdToast = $mdToast
                window.$mdBottomSheet = $mdBottomSheet
                window.$mdDialog = $mdDialog

                $scope.menuIndex = 0

                $scope.login = function () {
                    loginFunction(updateCoins)
                }

                $scope.options = function (domain) {
                    openOptionsDialog(domain, updateCoins)
                }

                $scope.logout = function () {
                    wallet.logout()
                    showSuccess("Success logout")
                    updateCoins()
                }

                $scope.newCoin = function () {
                    openLaunchDialog($scope.search_text, updateCoins)
                }


                $scope.coins = []
                $scope.recs = []
                var recDomains = []

                $scope.$watch('search_text', function (newValue) {
                    post('/wallet/api/search.php', {
                        search_text: newValue
                    }, function (response) {
                        recDomains = response.result
                        updateCoins()
                    })
                })

                function updateCoins() {
                    post("/wallet/api/list.php", {
                        domains: storage.getStringArray(storageKeys.domains).join(","),
                        address: wallet.username,
                    }, function (response) {
                        $scope.coins = response.result
                        $scope.$apply()
                    })
                    post("/wallet/api/list.php", {
                        domains: getRecsList().join(",")
                    }, function (response) {
                        $scope.recs = response.result
                        $scope.$apply()
                    })

                    $scope.drops = storage.getObject(storageKeys.drops, [])
                    if ($scope.drops.length > 0) {
                        var dropDomains = []
                        for (const drop of $scope.drops)
                            dropDomains.push(drop.domain)
                        post("/wallet/api/list.php", {
                            domains: dropDomains.join(",")
                        }, function (response) {
                            for (const dropToken of response.result)
                                $scope.dropTokens[dropToken.domain] = dropToken
                            $scope.$apply()
                        })
                    }
                }

                function getRecsList() {
                    var result = []
                    var domains = storage.getStringArray(storageKeys.domains)
                    for (let domain of recDomains)
                        if (domains.indexOf(domain) == -1)
                            result.push(domain)
                    return result
                }

                $scope.toggleFavorite = function (domain) {
                    wallet.auth(function (username) {
                        postContract(domain, contract.wallet, {
                            address: username
                        }, function () {
                            addToStorage(domain)
                        }, function () {
                            postContractWithGas(domain, contract.reg, {
                                address: username,
                                next_hash: wallet.calcStartHash(domain + "/wallet")
                            }, function () {
                                addToStorage(domain)
                            })
                        })
                    })

                    function addToStorage(domain) {
                        if (!storage.isArrayItemExist(storageKeys.domains, domain)) {
                            storage.pushToArray(storageKeys.domains, domain)
                        } else {
                            storage.removeFromArray(storageKeys.domains, domain)
                        }
                        updateCoins()
                    }
                }

                $scope.username = function () {
                    return wallet.username
                }

                setInterval(function () {
                    updateCoins()
                }, 20000)

                if (storage.getString("email") != "" && wallet.password == "") {
                    loginFunction(updateCoins)
                }

                $scope.drops = storage.getObject(storageKeys.drops, [])
                $scope.dropTokens = {}
                if (storage.getString("invite_key") != "") {
                    var invite_id = storage.getString("invite_id")
                    var isExist = false
                    for (const drop of $scope.drops)
                        if (drop.invite_id == invite_id)
                            isExist = true
                    if (!isExist) {
                        $scope.drops.push({
                            domain: storage.getString("domain"),
                            amount: storage.getString("amount"),
                            invite_id: storage.getString("invite_id"),
                            invite_key: storage.getString("invite_key"),
                        })
                        storage.setObject(storageKeys.drops, $scope.drops)
                    }
                }

                $scope.receiveDrop = function (drop) {
                    wallet.auth(function (username) {
                        postContractWithGas(drop.domain, contract.bonus_receive, {
                            invite_id: drop.invite_id,
                            to_address: username,
                            key: drop.invite_key,
                        }, function () {
                            var drops = []
                            for (const item of storage.getObject(storageKeys.drops, []))
                                if (item.invite_id != drop.invite_id)
                                    drops.push(item)
                            storage.setObject(storageKeys.drops, drops)
                            updateCoins()
                            showSuccessDialog("You have been received " + drop.amount + " " + drop.domain)
                        })
                    })
                }
            })
    </script>
</head>
<body class="col" ng-app="App" ng-controller="Controller">
<div class="row row-content align-start-center blue-back" style="padding: 4px 0">
    <img class="img36 img-red" src="logo.svg"/>
    <div class="row flex input-wrapper">
        <input type="text" class="flex input" ng-model="search_text" placeholder="Search"
               style="border-radius: 20px; padding-top: 1px">
    </div>
    <md-menu md-position-mode="target-right target">
        <img class="img36 img-white" src="img/menu.svg" ng-click="$mdMenu.open($event)"/>
        <md-menu-content width="4" class="col-content">
            <md-menu-item ng-click="newCoin()">
                New coin
            </md-menu-item>
            <md-menu-item ng-click="login()">
                Login
            </md-menu-item>
            <md-menu-item ng-click="logout()">
                Logout {{username()}}
            </md-menu-item>
        </md-menu-content>
    </md-menu>
</div>
<div class="row shadow-black gray-back"
     style="padding: 16px"
     ng-show="coins.length">
    <div class="flex col">
        <p class="size12">Total balance</p>
        <p class="size16 bold-text" style="margin-top: 4px">{{formatPrice(0)}}</p>
    </div>
    <div class="col align-end-end">
        <p class="size12 uppercase">Gas</p>
        <p class="size14 bold-text" style="margin-top: 4px">{{formatAmount(0)}}</p>
    </div>
</div>
<div class="row"
     style="padding: 16px"
     ng-hide="coins.length">
    <div class="flex primary-button lowercase"
         ng-click="login()"
    >Login or Create account
    </div>
</div>
<div class="col col-content row-content" ng-show="coins.length">
    <p>Your coins</p>
</div>
<div class="col" ng-repeat="item in coins">
    <div class="row align-start-center row-content white-back-ripple"
         ng-click="options(item.domain)"
         style="padding: 8px 0 8px 0;">
        <img class="img36" src="{{item.logo}}">
        <p class="flex size14 uppercase">{{item.domain}}</p>
        <div class="col align-end-end">
            <p>{{formatPrice(item.price * item.balance)}}</p>
            <p class="size12 uppercase" style="margin-top: 4px">{{formatAmount(item.balance) + " " + item.domain}}</p>
        </div>
    </div>
    <div class="divider"></div>
</div>
<div class="col col-content row-content" ng-show="drops.length">
    <p>Drop coins</p>
</div>
<div class="col" ng-repeat="item in drops">
    <div class="row align-start-center row-content white-back-ripple"
         ng-click="receiveDrop(item)"
         style="padding: 8px 0 8px 0;">
        <img class="img36" src="{{dropTokens[item.domain].logo}}">
        <p class="flex size14 uppercase">{{item.domain}}</p>
        <div class="primary-button" ng-click="receive(item.invite_id)">Receive {{item.amount}} {{item.domain}}</div>
    </div>
    <div class="divider"></div>
</div>
<div class="col col-content row-content" ng-show="recs.length">
    <p>Recommended coins</p>
</div>
<div class="col" ng-repeat="item in recs">
    <div class="row align-start-center row-content white-back-ripple"
         style="padding: 8px 0 8px 0;">
        <img class="img36" src="{{item.logo}}">
        <p class="flex size14 uppercase">{{item.domain}}</p>
        <md-switch ng-change="toggleFavorite(item.domain)"
                   ng-model="item.isFavorite"/>
    </div>
    <div class="divider"></div>
</div>
</body>
</html>