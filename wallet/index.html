<!DOCTYPE html>
<html lang="en">
<head>
    <!--https://material.angularjs.org/latest/-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet</title>
    <link rel="icon" type="image/x-icon" href="logo.svg">
    <script src="/angular/angular.min.js"></script>
    <link href="/angular/angular-material.min.css" rel="stylesheet">
    <link href="/angular/binance_style.css" rel="stylesheet">
    <link href="/angular/colors.css" rel="stylesheet">
    <script src="/angular/angular-material.min.js"></script>
    <script src="/wallet/utils.js"></script>
    <script src="formats.js"></script>
    <link href="style.css" rel="stylesheet">


    <script src="/wallet/options/controller.js"></script>
    <script src="/wallet/launch/controller.js"></script>
    <script src="/wallet/login/controller.js"></script>
    <script src="/wallet/send/controller.js"></script>
    <script src="/wallet/ico_sell/controller.js"></script>
    <script src="/wallet/ico_buy/controller.js"></script>

    <script>
        angular.module("App", ['ngMaterial', 'ngAnimate'])
            .controller("Controller", function ($scope, $http, $mdBottomSheet, $mdDialog, $mdToast) {
                addFormats($scope)
                window.$mdToast = $mdToast
                window.$mdBottomSheet = $mdBottomSheet
                window.$mdDialog = $mdDialog

                $scope.menuIndex = 0

                $scope.login = function () {
                    loginFunction(updateCoins)
                }

                $scope.options = function (domain) {
                    openOptionsDialog(domain, updateCoins)
                }

                $scope.logout = function () {
                    wallet.logout()
                    showSuccess("Success logout")
                    updateCoins()
                }

                $scope.newCoin = function () {
                    openLaunchDialog($scope.search_text, updateCoins)
                }

                $scope.$watch('search_text', function (newValue) {
                    if (newValue == null) return;
                    if (newValue == "") {
                        updateCoins()
                    } else {
                        post('/wallet/api/search.php', {
                            path: "wallet/info",
                            search_text: newValue
                        }, function (response) {
                            $scope.recs = response.result
                            for (let coin of response.result)
                                coin.isFavorite = wallet.domainExist(coin.domain)
                            $scope.$apply()
                        }, function () {
                            $scope.recs = []
                            $scope.$apply()
                        })
                    }
                })

                $scope.coins = []
                $scope.recs = []

                function updateCoins() {
                    var domains = wallet.domains()
                    if (domains.length == 0) {
                        $scope.coins = []
                    } else {
                        wallet.auth(function () {
                            post("/wallet/api/list.php", {
                                domains: domains.join(","),
                                address: wallet.username,
                            }, function (response) {
                                $scope.coins = response.result
                                $scope.$apply()
                            })
                        })
                    }

                    var recDomains = [
                        "data",
                        "usdt",
                    ]
                    for (let domain of wallet.domains())
                        if (recDomains.indexOf(domain) != -1)
                            recDomains.splice(recDomains.indexOf(domain), 1)
                    if (recDomains.length == 0) {
                        $scope.recs = []
                    } else {
                        post("/wallet/api/list.php", {
                            domains: recDomains.join(",")
                        }, function (response) {
                            $scope.recs = response.result
                            $scope.$apply()
                        })
                    }
                }

                $scope.toggleFavorite = function (domain) {
                    wallet.auth(function (username) {
                        postContract(domain, data10.wallet, {
                            address: username
                        }, function () {
                            addToStorage(domain)
                        }, function () {
                            postContractWithGas(domain, data10.reg, {
                                address: username,
                                next_hash: wallet.calchashStart(domain + "/wallet")
                            }, function () {
                                addToStorage(domain)
                            })
                        })
                    })
                    function addToStorage(domain) {
                        if (wallet.domainExist(domain)) {
                            wallet.domainDel(domain)
                        } else {
                            wallet.domainAdd(domain)
                        }
                        updateCoins()
                    }
                }

                $scope.username = function () {
                    return wallet.username
                }

                setInterval(function () {
                    updateCoins()
                }, 10000)

                updateCoins()
            })
    </script>
</head>
<body class="col" ng-app="App" ng-controller="Controller">
<div class="row row-content align-start-center blue-back" style="padding: 4px 0">
    <img class="img36 img-red" src="logo.svg"/>
    <div class="row flex input-wrapper">
        <input type="text" class="flex input" ng-model="search_text" placeholder="Search"
               style="border-radius: 20px; padding-top: 1px">
    </div>
    <md-menu md-position-mode="target-right target">
        <img class="img36 img-white" src="img/menu.svg" ng-click="$mdMenu.open($event)"/>
        <md-menu-content width="4" class="col-content">
            <md-menu-item ng-click="newCoin()">
                New coin
            </md-menu-item>
            <md-menu-item ng-click="login()">
                Login
            </md-menu-item>
            <md-menu-item ng-click="logout()">
                Logout {{username()}}
            </md-menu-item>
        </md-menu-content>
    </md-menu>
</div>
<div class="row shadow-black gray-back"
     style="padding: 16px"
     ng-show="coins.length">
    <div class="flex col">
        <p class="size12">Total balance</p>
        <p class="size16 bold-text" style="margin-top: 4px">{{formatPrice(12022.022)}}</p>
    </div>
    <div class="col align-end-end">
        <p class="size12 uppercase">Gas</p>
        <p class="size14 bold-text" style="margin-top: 4px">{{formatAmount(25050)}}</p>
    </div>
</div>
<div class="row"
     style="padding: 16px"
     ng-hide="coins.length">
    <div class="flex primary-button lowercase"
         ng-click="login()"
    >Login or Create account</div>
</div>
<div class="col col-content row-content" ng-show="coins.length">
    <p>Your coins</p>
</div>
<div class="col" ng-repeat="item in coins">
    <div class="row align-start-center row-content white-back-ripple"
         ng-click="options(item.domain)"
         style="padding: 8px 0 8px 0;">
        <img class="img36" src="img/coin.svg">
        <p class="flex size14 uppercase">{{item.domain}}</p>
        <div class="col align-end-end">
            <p>{{formatPrice(item.price * item.balance)}}</p>
            <p class="size12 uppercase"  style="margin-top: 4px">{{formatAmount(item.balance) + " " + item.domain}}</p>
        </div>
    </div>
    <div class="divider"></div>
</div>
<div class="col col-content row-content" ng-show="recs.length">
    <p>Recommended coins</p>
</div>
<div class="col" ng-repeat="item in recs">
    <div class="row align-start-center row-content white-back-ripple"
         style="padding: 8px 0 8px 0;">
        <img class="img36" src="img/coin.svg">
        <p class="flex size14 uppercase">{{item.domain}}</p>
        <md-switch ng-change="toggleFavorite(item.domain)"
                   ng-model="item.isFavorite"/>
    </div>
    <div class="divider"></div>
</div>
</body>
</html>